@startuml authentication-flow
!theme cerulean
title Luá»“ng XÃ¡c thá»±c (Authentication Flow)

actor "User" as user
participant "AuthController" as auth
participant "AuthService" as authService
participant "UserDetailsService" as userDetails
participant "JwtTokenProvider" as jwt
database "PostgreSQL" as db

== ÄÄƒng nháº­p ==
user -> auth : POST /api/auth/login\n{username, password}
auth -> authService : login(loginRequest)
authService -> userDetails : loadUserByUsername(username)
userDetails -> db : findByUsername()
db --> userDetails : User entity
userDetails --> authService : UserPrincipal

alt Máº­t kháº©u há»£p lá»‡
    authService -> authService : authenticate()
    authService -> jwt : generateToken(userPrincipal)
    jwt --> authService : JWT Token
    authService --> auth : LoginResponse
    auth --> user : 200 OK\n{accessToken, user info}
else Máº­t kháº©u khÃ´ng há»£p lá»‡
    authService --> auth : AuthenticationException
    auth --> user : 401 Unauthorized
end

== Truy cáº­p API vá»›i Token ==
user -> auth : GET /api/auth/me\nAuthorization: Bearer <token>
auth -> jwt : validateToken(token)
jwt --> auth : true/false

alt Token há»£p lá»‡
    auth -> jwt : getUserIdFromToken(token)
    jwt --> auth : userId
    auth -> userDetails : loadUserById(userId)
    userDetails -> db : findById()
    db --> userDetails : User
    userDetails --> auth : UserPrincipal
    auth --> user : 200 OK\n{user info}
else Token khÃ´ng há»£p lá»‡
    auth --> user : 401 Unauthorized
end

@enduml

@startuml authorization-flow
!theme cerulean
title Luá»“ng PhÃ¢n quyá»n RBAC + ABAC (Authorization Flow)

actor "User" as user
participant "MockAPI\nController" as controller
participant "Authorization\nService" as authz
participant "AuditLog\nRepository" as audit
database "PostgreSQL" as db

user -> controller : API Request\n+ JWT Token
controller -> controller : Extract UserPrincipal\nfrom SecurityContext

controller -> authz : authorize(AuthorizationRequest)

note right of authz
  AuthorizationRequest:
  - resourceType
  - action
  - resourceBranch
  - resourceDepartment
  - patientId
  - createdBy
  - environment
end note

== RBAC Check ==
authz -> authz : checkRbacPermission()\nrole â†’ resource â†’ action

== Deny Rules Check ==
authz -> authz : checkDenyRules()
note right
  - RECEPTIONIST_NO_CLINICAL_ACCESS
  - CASHIER_NO_CLINICAL_ACCESS
  - HR_NO_PATIENT_OR_FINANCE_ACCESS
  - ITADMIN_NO_PATIENT_DATA
  - NO_DELETE_PATIENT_DATA
  - BRANCH_MISMATCH
  - SOD_CREATOR_CANNOT_APPROVE
  - EXPORT_REQUIRES_APPROVAL
end note

== ABAC Check ==
authz -> authz : checkAbacConditions()
note right
  - checkPatientAssigned()
  - checkSameBranch()
  - checkSameDepartment()
end note

== Risk Score ==
authz -> authz : calculateRiskScore()
note right
  - Off-hours: +2
  - Export action: +3
  - High sensitivity: +2
  - High-risk resource: +3
  - High-risk action: +2
end note

== Add Obligations ==
authz -> authz : addObligations()
note right
  - step_up_mfa
  - mask_fields
  - log_high_risk
  - require_approval_ref
  - rate_limit
end note

== Audit Logging ==
authz -> audit : save(AuditLog)
audit -> db : INSERT audit_logs

authz --> controller : AuthorizationResponse

alt allowed = true
    controller -> controller : Process Request
    controller --> user : 200 OK\n{data}
else allowed = false
    controller --> user : 403 Forbidden\n{denyReasons}
end

@enduml

@startuml sequence-medical-record-access
!theme cerulean
title Sequence Diagram: BÃ¡c sÄ© Ä‘á»c Há»“ sÆ¡ Bá»‡nh Ã¡n

actor "Doctor\n(U0000)" as doctor
participant "JwtFilter" as filter
participant "MedicalRecord\nController" as controller
participant "Authorization\nService" as authz
participant "AuditLog\nRepository" as audit

doctor -> filter : GET /api/mock/medical-records/MR001\nAuthorization: Bearer <token>

filter -> filter : Validate JWT
filter -> filter : Set SecurityContext\nwith UserPrincipal

filter -> controller : Forward Request

controller -> controller : @AuthenticationPrincipal\nUserPrincipal user

controller -> authz : authorize()
note right
  resourceType: "MedicalRecord"
  action: "read"
  resourceBranch: "BRANCH_HCM"
  patientId: "PAT001"
end note

authz -> authz : RBAC Check\nDoctor â†’ MedicalRecord â†’ read âœ“

authz -> authz : Deny Rules Check\n(No violations) âœ“

authz -> authz : ABAC Check
note right
  Is PAT001 in doctor's
  assigned patients?
  P00001 âˆˆ {P00001, P00002...} âœ“
end note

authz -> authz : Calculate Risk Score\n= 3 (high-risk resource)

authz -> audit : Log Decision
note right
  userId: U0000
  resourceType: MedicalRecord
  action: read
  allowed: true
  policyId: ALLOW_Doctor_MedicalRecord_read
  riskScore: 3
end note

authz --> controller : AuthorizationResponse\n{allowed: true}

controller -> controller : Fetch MedicalRecord\nfrom Mock Data

controller --> doctor : 200 OK\n{medicalRecord}

@enduml

@startuml sequence-prescription-approve-sod
!theme cerulean
title Sequence Diagram: Separation of Duties - Approve Prescription

actor "Doctor A\n(Creator)" as docA
actor "Doctor B\n(Approver)" as docB
participant "Prescription\nController" as controller
participant "Authorization\nService" as authz

== Doctor A táº¡o Ä‘Æ¡n thuá»‘c ==
docA -> controller : POST /api/mock/prescriptions\n{patientId, medications...}
controller -> authz : authorize(Prescription, create)
authz --> controller : {allowed: true}
controller -> controller : Create RX001\ncreatedBy: DOC_A
controller --> docA : 201 Created\n{prescriptionId: RX001}

== Doctor A cá»‘ approve Ä‘Æ¡n thuá»‘c cá»§a mÃ¬nh ==
docA -> controller : POST /api/mock/prescriptions/RX001/approve

controller -> authz : authorize()
note right
  resourceType: "Prescription"
  action: "approve"
  createdBy: "DOC_A"  â† same as current user
end note

authz -> authz : RBAC Check âœ“
authz -> authz : **SoD Check**
note right #pink
  **SOD_CREATOR_CANNOT_APPROVE**
  createdBy == currentUser
  â†’ DENIED
end note

authz --> controller : {allowed: false,\ndenyReasons: ["SOD_CREATOR_CANNOT_APPROVE"]}

controller --> docA : 403 Forbidden\n"Creator cannot approve own prescription"

== Doctor B approve Ä‘Æ¡n thuá»‘c ==
docB -> controller : POST /api/mock/prescriptions/RX001/approve

controller -> authz : authorize()
note right
  resourceType: "Prescription"
  action: "approve"
  createdBy: "DOC_A"  â† different from DOC_B
end note

authz -> authz : RBAC Check âœ“
authz -> authz : SoD Check âœ“
authz -> authz : ABAC Check âœ“

authz --> controller : {allowed: true}

controller -> controller : Update prescription\nstatus: "Approved"\napprovedBy: DOC_B

controller --> docB : 200 OK\n{prescription: approved}

@enduml

@startuml class-diagram
!theme cerulean
title Class Diagram: Core Entities

package "Entity" {
    class User {
        -Long id
        -String userId
        -String username
        -String password
        -Role role
        -String department
        -String branch
        -String position
        -boolean hasLicense
        -String seniority
        -String employmentType
        -Set<String> assignedPatients
        -Set<Permission> additionalPermissions
        -boolean enabled
    }
    
    class Role {
        -Long id
        -String name
        -String description
        -Set<Permission> permissions
    }
    
    class Permission {
        -Long id
        -String resourceType
        -String action
        -String scope
        -String description
        -String permissionKey
    }
    
    class AuditLog {
        -Long id
        -String userId
        -String resourceType
        -String resourceId
        -String action
        -boolean allowed
        -String policyId
        -String denyReasons
        -Integer riskScore
        -LocalDateTime timestamp
    }
}

package "Security" {
    class UserPrincipal {
        -Long id
        -String userId
        -String username
        -String role
        -String department
        -String branch
        -Set<String> assignedPatients
        -Collection<GrantedAuthority> authorities
        +create(User): UserPrincipal
        +getPermissionKeys(): Set<String>
    }
    
    class JwtTokenProvider {
        +generateToken(UserPrincipal): String
        +validateToken(String): boolean
        +getUserIdFromToken(String): Long
    }
    
    class JwtAuthenticationFilter {
        +doFilterInternal()
    }
}

package "DTO" {
    class AuthorizationRequest {
        -String resourceType
        -String action
        -String resourceId
        -String resourceBranch
        -String resourceDepartment
        -String patientId
        -String resourceSensitivity
        -String createdBy
        -Map<String,Object> environment
    }
    
    class AuthorizationResponse {
        -boolean allowed
        -String policyId
        -List<String> denyReasons
        -List<Map<String,Object>> obligations
        -Integer riskScore
    }
}

package "Service" {
    class AuthorizationService {
        -Map<String, Map<String, Set<String>>> ROLE_PERMISSIONS
        +authorize(AuthorizationRequest): AuthorizationResponse
        +hasPermission(String, String): boolean
        -checkRbacPermission()
        -checkDenyRules()
        -checkAbacConditions()
        -calculateRiskScore()
        -addObligations()
    }
}

User "N" -- "1" Role
Role "N" -- "N" Permission
User ..> UserPrincipal : creates
AuthorizationService --> AuthorizationRequest : uses
AuthorizationService --> AuthorizationResponse : returns
AuthorizationService --> AuditLog : creates

@enduml

@startuml use-case-diagram
!theme cerulean
title Use Case Diagram: EMR System Roles

left to right direction

actor "Doctor" as doctor
actor "Nurse" as nurse
actor "Receptionist" as receptionist
actor "Cashier" as cashier
actor "HR" as hr
actor "Manager" as manager
actor "ITAdmin" as itadmin
actor "SecurityAdmin" as secadmin

rectangle "EMR System" {
    ' Clinical
    usecase "Xem há»“ sÆ¡ bá»‡nh Ã¡n" as UC1
    usecase "Táº¡o/Sá»­a há»“ sÆ¡ bá»‡nh Ã¡n" as UC2
    usecase "Táº¡o Ä‘Æ¡n thuá»‘c" as UC3
    usecase "PhÃª duyá»‡t Ä‘Æ¡n thuá»‘c" as UC4
    usecase "YÃªu cáº§u xÃ©t nghiá»‡m" as UC5
    usecase "Xem káº¿t quáº£ xÃ©t nghiá»‡m" as UC6
    usecase "Ghi nháº­n sinh hiá»‡u" as UC7
    usecase "Táº¡o tÃ³m táº¯t xuáº¥t viá»‡n" as UC8
    
    ' Administrative
    usecase "ÄÄƒng kÃ½ bá»‡nh nhÃ¢n" as UC9
    usecase "Quáº£n lÃ½ lá»‹ch háº¹n" as UC10
    usecase "Nháº­p viá»‡n/Chuyá»ƒn khoa" as UC11
    
    ' Finance
    usecase "Táº¡o hÃ³a Ä‘Æ¡n" as UC12
    usecase "PhÃª duyá»‡t Invoice" as UC13
    usecase "Quáº£n lÃ½ báº£o hiá»ƒm" as UC14
    usecase "Xem bÃ¡o cÃ¡o tÃ i chÃ­nh" as UC15
    
    ' HR
    usecase "Quáº£n lÃ½ nhÃ¢n viÃªn" as UC16
    usecase "Quáº£n lÃ½ lá»‹ch lÃ m viá»‡c" as UC17
    usecase "Quáº£n lÃ½ Ä‘Ã o táº¡o" as UC18
    usecase "Xem bÃ¡o cÃ¡o váº­n hÃ nh" as UC19
    
    ' IT/Security
    usecase "Cáº¥u hÃ¬nh há»‡ thá»‘ng" as UC20
    usecase "Quáº£n lÃ½ Access Policy" as UC21
    usecase "Xem Audit Logs" as UC22
    usecase "Quáº£n lÃ½ sá»± cá»‘" as UC23
    
    ' Reports
    usecase "Xem bÃ¡o cÃ¡o y táº¿" as UC24
}

' Doctor
doctor --> UC1
doctor --> UC2
doctor --> UC3
doctor --> UC4
doctor --> UC5
doctor --> UC6
doctor --> UC8
doctor --> UC24

' Nurse
nurse --> UC1
nurse --> UC6
nurse --> UC7

' Receptionist
receptionist --> UC9
receptionist --> UC10
receptionist --> UC11

' Cashier
cashier --> UC12
cashier --> UC13
cashier --> UC14
cashier --> UC15

' HR
hr --> UC16
hr --> UC17
hr --> UC18
hr --> UC19

' Manager
manager --> UC15
manager --> UC16 : (read only)
manager --> UC17 : (read only)
manager --> UC19
manager --> UC24

' ITAdmin
itadmin --> UC20
itadmin --> UC21 : (read only)
itadmin --> UC22

' SecurityAdmin
secadmin --> UC20 : (read only)
secadmin --> UC21
secadmin --> UC22
secadmin --> UC23

@enduml

@startuml component-diagram
!theme cerulean
title Component Diagram: System Architecture

package "Client Layer" {
    [Web Browser] as browser
    [Mobile App] as mobile
    [API Client] as apiclient
}

package "API Gateway" {
    [Spring Security\nFilter Chain] as security
    [JWT Authentication\nFilter] as jwtfilter
}

package "Controller Layer" {
    [AuthController] as authCtrl
    [AuthorizationController] as authzCtrl
    [AuditController] as auditCtrl
    [UserController] as userCtrl
    
    package "Mock API Controllers" {
        [PatientController] as patientCtrl
        [MedicalRecordController] as mrCtrl
        [PrescriptionController] as rxCtrl
        [BillingController] as billCtrl
        [StaffController] as staffCtrl
        [SystemController] as sysCtrl
        [... 7 more controllers] as otherCtrl
    }
}

package "Service Layer" {
    [AuthService] as authSvc
    [AuthorizationService] as authzSvc
    [AuditService] as auditSvc
    [CustomUserDetailsService] as userSvc
}

package "Security Components" {
    [JwtTokenProvider] as jwt
    [UserPrincipal] as principal
}

package "Repository Layer" {
    [UserRepository] as userRepo
    [RoleRepository] as roleRepo
    [PermissionRepository] as permRepo
    [AuditLogRepository] as auditRepo
}

database "PostgreSQL" as db {
    [users]
    [roles]
    [permissions]
    [audit_logs]
    [role_permissions]
    [user_permissions]
}

' Connections
browser --> security
mobile --> security
apiclient --> security

security --> jwtfilter
jwtfilter --> authCtrl
jwtfilter --> authzCtrl
jwtfilter --> auditCtrl
jwtfilter --> userCtrl
jwtfilter --> patientCtrl
jwtfilter --> mrCtrl
jwtfilter --> rxCtrl
jwtfilter --> billCtrl
jwtfilter --> staffCtrl
jwtfilter --> sysCtrl

authCtrl --> authSvc
authzCtrl --> authzSvc
auditCtrl --> auditSvc
patientCtrl --> authzSvc
mrCtrl --> authzSvc
rxCtrl --> authzSvc

authSvc --> jwt
authSvc --> userSvc
authzSvc --> auditRepo

userSvc --> userRepo
userRepo --> db
roleRepo --> db
permRepo --> db
auditRepo --> db

@enduml

@startuml state-diagram-prescription
!theme cerulean
title State Diagram: Prescription Lifecycle

[*] --> Draft : Doctor creates

Draft --> Pending : Doctor submits
Draft --> Cancelled : Doctor cancels

Pending --> Approved : Another Doctor approves\n(SoD enforced)
Pending --> Draft : Doctor requests revision
Pending --> Cancelled : Doctor/Admin cancels

Approved --> Dispensed : Pharmacy dispenses

Dispensed --> [*]
Cancelled --> [*]

note right of Pending
  **Separation of Duties:**
  Creator cannot approve
  their own prescription
end note

note right of Approved
  Requires:
  - Different doctor than creator
  - Same branch
  - Valid license
end note

@enduml

@startuml activity-diagram-authorization
!theme cerulean
title Activity Diagram: Authorization Decision Process

start

:Receive Authorization Request;
note right
  - resourceType
  - action
  - resourceBranch
  - patientId
  - createdBy
  - environment
end note

:Extract UserPrincipal from SecurityContext;

partition "RBAC Check" {
    :Get role permissions map;
    if (Role has permission for\nresource + action?) then (yes)
        :RBAC = ALLOW;
    else (no)
        :RBAC = DENY;
        :Add to denyReasons;
    endif
}

partition "Deny Rules Check" {
    :Check explicit deny rules;
    
    if (Receptionist accessing clinical data?) then (yes)
        :Add RECEPTIONIST_NO_CLINICAL_ACCESS;
    endif
    
    if (Delete action on patient data?) then (yes)
        :Add NO_DELETE_PATIENT_DATA;
    endif
    
    if (Branch mismatch?) then (yes)
        :Add BRANCH_MISMATCH;
    endif
    
    if (Creator trying to approve?) then (yes)
        :Add SOD_CREATOR_CANNOT_APPROVE;
    endif
    
    if (Export without approval?) then (yes)
        :Add EXPORT_REQUIRES_APPROVAL;
    endif
}

partition "ABAC Check" {
    if (Clinical resource?) then (yes)
        if (Doctor role?) then (yes)
            :Check patient assigned;
        else (Nurse role)
            :Check patient assigned;
            :Check same department;
        endif
    endif
    
    if (PatientProfile or Appointment?) then (yes)
        :Check same branch;
    endif
}

partition "Risk Scoring" {
    :Initialize score = 0;
    
    if (Off-hours access?) then (yes)
        :score += 2;
    endif
    
    if (Export action?) then (yes)
        :score += 3;
    endif
    
    if (High-risk resource?) then (yes)
        :score += 3;
    endif
}

:Determine final decision;
note right
  allowed = RBAC_OK 
    && ABAC_OK 
    && denyReasons.isEmpty()
end note

if (allowed?) then (yes)
    partition "Add Obligations" {
        if (Off-hours?) then (yes)
            :Add step_up_mfa obligation;
        endif
        
        if (PatientProfile && !Receptionist?) then (yes)
            :Add mask_fields obligation;
        endif
        
        if (High-risk action?) then (yes)
            :Add log_high_risk obligation;
        endif
    }
endif

:Log to AuditLog;
:Return AuthorizationResponse;

stop

@enduml

' ============================================
' USE CASE DIAGRAMS - CHI TIáº¾T THEO DOMAIN
' ============================================

@startuml usecase-overview
!theme cerulean
title Use Case Tá»•ng quan: Há»‡ thá»‘ng EMR vá»›i RBAC/ABAC

left to right direction
skinparam actorStyle awesome
skinparam packageStyle rectangle

actor "BÃ¡c sÄ©\n(Doctor)" as doctor #LightBlue
actor "Y tÃ¡\n(Nurse)" as nurse #LightGreen
actor "Lá»… tÃ¢n\n(Receptionist)" as receptionist #LightYellow
actor "Thu ngÃ¢n\n(Cashier)" as cashier #LightPink
actor "NhÃ¢n sá»±\n(HR)" as hr #LightCoral
actor "Quáº£n lÃ½\n(Manager)" as manager #Lavender
actor "IT Admin" as itadmin #LightGray
actor "Security Admin" as secadmin #Tomato

rectangle "Há»‡ thá»‘ng EMR" {
    package "ðŸ¥ Clinical Domain" as clinical {
        usecase "Quáº£n lÃ½ Há»“ sÆ¡ Bá»‡nh Ã¡n" as UC_MR
        usecase "Quáº£n lÃ½ ÄÆ¡n thuá»‘c" as UC_RX
        usecase "XÃ©t nghiá»‡m & CÄHA" as UC_LAB
        usecase "Ghi nháº­n Sinh hiá»‡u" as UC_VITAL
    }
    
    package "ðŸ“‹ Administrative Domain" as admin {
        usecase "ÄÄƒng kÃ½ Bá»‡nh nhÃ¢n" as UC_PAT
        usecase "Quáº£n lÃ½ Lá»‹ch háº¹n" as UC_APT
        usecase "Nháº­p/Xuáº¥t viá»‡n" as UC_ADM
    }
    
    package "ðŸ’° Finance Domain" as finance {
        usecase "Thanh toÃ¡n & HÃ³a Ä‘Æ¡n" as UC_BILL
        usecase "Báº£o hiá»ƒm Y táº¿" as UC_INS
        usecase "BÃ¡o cÃ¡o TÃ i chÃ­nh" as UC_FIN_RPT
    }
    
    package "ðŸ‘¥ HR Domain" as hrdomain {
        usecase "Quáº£n lÃ½ NhÃ¢n viÃªn" as UC_STAFF
        usecase "Lá»‹ch lÃ m viá»‡c" as UC_SCHED
        usecase "ÄÃ o táº¡o & Chá»©ng chá»‰" as UC_TRAIN
    }
    
    package "âš™ï¸ System Domain" as system {
        usecase "Cáº¥u hÃ¬nh Há»‡ thá»‘ng" as UC_CONFIG
        usecase "ChÃ­nh sÃ¡ch Truy cáº­p" as UC_POLICY
        usecase "Audit & GiÃ¡m sÃ¡t" as UC_AUDIT
        usecase "Quáº£n lÃ½ Sá»± cá»‘" as UC_INCIDENT
    }
    
    package "ðŸ“Š Reporting Domain" as reporting {
        usecase "BÃ¡o cÃ¡o Y táº¿" as UC_MED_RPT
        usecase "BÃ¡o cÃ¡o Váº­n hÃ nh" as UC_OP_RPT
    }
}

' Doctor connections
doctor --> UC_MR
doctor --> UC_RX
doctor --> UC_LAB
doctor --> UC_MED_RPT

' Nurse connections
nurse --> UC_MR : <<read>>
nurse --> UC_VITAL
nurse --> UC_LAB : <<read>>

' Receptionist connections
receptionist --> UC_PAT
receptionist --> UC_APT
receptionist --> UC_ADM

' Cashier connections
cashier --> UC_BILL
cashier --> UC_INS
cashier --> UC_FIN_RPT

' HR connections
hr --> UC_STAFF
hr --> UC_SCHED
hr --> UC_TRAIN
hr --> UC_OP_RPT

' Manager connections
manager --> UC_FIN_RPT : <<read>>
manager --> UC_OP_RPT : <<read>>
manager --> UC_MED_RPT : <<read>>
manager --> UC_STAFF : <<read>>

' IT Admin connections
itadmin --> UC_CONFIG
itadmin --> UC_POLICY : <<read>>
itadmin --> UC_AUDIT

' Security Admin connections
secadmin --> UC_CONFIG : <<read>>
secadmin --> UC_POLICY
secadmin --> UC_AUDIT
secadmin --> UC_INCIDENT

@enduml

@startuml usecase-clinical-domain
!theme cerulean
title Use Case: Clinical Domain (BÃ¡c sÄ© & Y tÃ¡)

left to right direction
skinparam actorStyle awesome

actor "BÃ¡c sÄ©" as doctor #LightBlue
actor "Y tÃ¡" as nurse #LightGreen
actor "Bá»‡nh nhÃ¢n" as patient #WhiteSmoke

rectangle "Clinical Domain" {
    package "Há»“ sÆ¡ Bá»‡nh Ã¡n" {
        usecase "Xem há»“ sÆ¡ bá»‡nh Ã¡n" as UC1
        usecase "Táº¡o há»“ sÆ¡ bá»‡nh Ã¡n má»›i" as UC2
        usecase "Cáº­p nháº­t há»“ sÆ¡" as UC3
        usecase "Export há»“ sÆ¡" as UC4
    }
    
    package "Ghi chÃº LÃ¢m sÃ ng" {
        usecase "Xem ghi chÃº" as UC5
        usecase "Táº¡o ghi chÃº tiáº¿n triá»ƒn" as UC6
        usecase "Táº¡o ghi chÃº Ä‘Ã¡nh giÃ¡" as UC7
    }
    
    package "Sinh hiá»‡u" {
        usecase "Xem sinh hiá»‡u" as UC8
        usecase "Ghi nháº­n sinh hiá»‡u" as UC9
        usecase "Cáº­p nháº­t sinh hiá»‡u" as UC10
    }
    
    package "ÄÆ¡n thuá»‘c" {
        usecase "Xem Ä‘Æ¡n thuá»‘c" as UC11
        usecase "Táº¡o Ä‘Æ¡n thuá»‘c" as UC12
        usecase "Sá»­a Ä‘Æ¡n thuá»‘c" as UC13
        usecase "PhÃª duyá»‡t Ä‘Æ¡n thuá»‘c" as UC14
    }
    
    package "XÃ©t nghiá»‡m" {
        usecase "YÃªu cáº§u xÃ©t nghiá»‡m" as UC15
        usecase "Xem káº¿t quáº£ xÃ©t nghiá»‡m" as UC16
    }
    
    package "Cháº©n Ä‘oÃ¡n HÃ¬nh áº£nh" {
        usecase "YÃªu cáº§u CÄHA" as UC17
        usecase "Xem káº¿t quáº£ CÄHA" as UC18
    }
    
    package "Xuáº¥t viá»‡n" {
        usecase "Táº¡o tÃ³m táº¯t xuáº¥t viá»‡n" as UC19
        usecase "Xem tÃ³m táº¯t xuáº¥t viá»‡n" as UC20
    }
}

' Doctor - Full access
doctor --> UC1
doctor --> UC2
doctor --> UC3
doctor --> UC4 : <<cáº§n approval>>
doctor --> UC5
doctor --> UC6
doctor --> UC7
doctor --> UC8
doctor --> UC11
doctor --> UC12
doctor --> UC13
doctor --> UC14 : <<SoD: khÃ´ng tá»± approve>>
doctor --> UC15
doctor --> UC16
doctor --> UC17
doctor --> UC18
doctor --> UC19
doctor --> UC20

' Nurse - Limited access
nurse --> UC1 : <<chá»‰ Ä‘á»c>>
nurse --> UC5 : <<chá»‰ Ä‘á»c>>
nurse --> UC8
nurse --> UC9
nurse --> UC10
nurse --> UC16 : <<chá»‰ Ä‘á»c>>
nurse --> UC18 : <<chá»‰ Ä‘á»c>>
nurse --> UC20 : <<chá»‰ Ä‘á»c>>

' Patient as beneficiary
UC1 ..> patient : <<liÃªn quan>>
UC11 ..> patient : <<liÃªn quan>>

note right of UC4
  **ABAC Rule:**
  Export cáº§n approval
  hoáº·c emergency mode
end note

note right of UC14
  **SoD Rule:**
  BÃ¡c sÄ© táº¡o Ä‘Æ¡n
  khÃ´ng thá»ƒ tá»± approve
end note

note bottom of nurse
  **ABAC Constraints:**
  - Chá»‰ bá»‡nh nhÃ¢n Ä‘Æ°á»£c assign
  - CÃ¹ng khoa (department)
  - CÃ¹ng chi nhÃ¡nh (branch)
end note

@enduml

@startuml usecase-administrative-domain
!theme cerulean
title Use Case: Administrative Domain (Lá»… tÃ¢n)

left to right direction
skinparam actorStyle awesome

actor "Lá»… tÃ¢n" as receptionist #LightYellow
actor "Bá»‡nh nhÃ¢n" as patient #WhiteSmoke
actor "BÃ¡c sÄ©" as doctor #LightBlue

rectangle "Administrative Domain" {
    package "Quáº£n lÃ½ Bá»‡nh nhÃ¢n" {
        usecase "ÄÄƒng kÃ½ bá»‡nh nhÃ¢n má»›i" as UC1
        usecase "Xem thÃ´ng tin bá»‡nh nhÃ¢n" as UC2
        usecase "Cáº­p nháº­t thÃ´ng tin" as UC3
        usecase "TÃ¬m kiáº¿m bá»‡nh nhÃ¢n" as UC4
    }
    
    package "Quáº£n lÃ½ Lá»‹ch háº¹n" {
        usecase "Táº¡o lá»‹ch háº¹n" as UC5
        usecase "Xem lá»‹ch háº¹n" as UC6
        usecase "Cáº­p nháº­t lá»‹ch háº¹n" as UC7
        usecase "Há»§y lá»‹ch háº¹n" as UC8
        usecase "Check-in bá»‡nh nhÃ¢n" as UC9
        usecase "ÄÃ¡nh dáº¥u No-show" as UC10
    }
    
    package "Nháº­p viá»‡n / Xuáº¥t viá»‡n" {
        usecase "Táº¡o báº£n ghi nháº­p viá»‡n" as UC11
        usecase "Xem thÃ´ng tin nháº­p viá»‡n" as UC12
        usecase "YÃªu cáº§u chuyá»ƒn khoa" as UC13
        usecase "Xem lá»‹ch sá»­ chuyá»ƒn khoa" as UC14
    }
}

' Receptionist - Full CRUD
receptionist --> UC1
receptionist --> UC2
receptionist --> UC3
receptionist --> UC4
receptionist --> UC5
receptionist --> UC6
receptionist --> UC7
receptionist --> UC8
receptionist --> UC9
receptionist --> UC10
receptionist --> UC11
receptionist --> UC12
receptionist --> UC13
receptionist --> UC14

' Relationships
UC1 ..> patient : <<táº¡o há»“ sÆ¡ cho>>
UC5 ..> patient : <<Ä‘áº·t lá»‹ch cho>>
UC5 ..> doctor : <<vá»›i bÃ¡c sÄ©>>
UC11 ..> patient : <<nháº­p viá»‡n>>

note right of receptionist
  **Deny Rules:**
  âŒ KhÃ´ng truy cáº­p Clinical Data
  âŒ KhÃ´ng xem MedicalRecord
  âŒ KhÃ´ng xem Prescription
  âŒ KhÃ´ng xem LabResult
end note

note bottom of UC2
  **ABAC:**
  Chá»‰ bá»‡nh nhÃ¢n
  cÃ¹ng chi nhÃ¡nh
end note

@enduml

@startuml usecase-finance-domain
!theme cerulean
title Use Case: Finance Domain (Thu ngÃ¢n & Quáº£n lÃ½)

left to right direction
skinparam actorStyle awesome

actor "Thu ngÃ¢n" as cashier #LightPink
actor "Quáº£n lÃ½" as manager #Lavender
actor "Bá»‡nh nhÃ¢n" as patient #WhiteSmoke

rectangle "Finance Domain" {
    package "HÃ³a Ä‘Æ¡n & Thanh toÃ¡n" {
        usecase "Táº¡o hÃ³a Ä‘Æ¡n" as UC1
        usecase "Xem hÃ³a Ä‘Æ¡n" as UC2
        usecase "Cáº­p nháº­t hÃ³a Ä‘Æ¡n" as UC3
        usecase "TÃ­nh tá»•ng chi phÃ­" as UC4
    }
    
    package "Invoice" {
        usecase "Táº¡o Invoice" as UC5
        usecase "Xem Invoice" as UC6
        usecase "PhÃª duyá»‡t Invoice" as UC7
        usecase "Gá»­i Invoice cho BN" as UC8
        usecase "Ghi nháº­n thanh toÃ¡n" as UC9
    }
    
    package "Báº£o hiá»ƒm Y táº¿" {
        usecase "Táº¡o yÃªu cáº§u báº£o hiá»ƒm" as UC10
        usecase "Xem claim báº£o hiá»ƒm" as UC11
        usecase "Cáº­p nháº­t claim" as UC12
        usecase "Theo dÃµi tráº¡ng thÃ¡i" as UC13
    }
    
    package "BÃ¡o cÃ¡o TÃ i chÃ­nh" {
        usecase "Xem bÃ¡o cÃ¡o doanh thu" as UC14
        usecase "Xem bÃ¡o cÃ¡o cÃ´ng ná»£" as UC15
        usecase "Xem thá»‘ng kÃª thanh toÃ¡n" as UC16
    }
}

' Cashier - Full CRUD on billing
cashier --> UC1
cashier --> UC2
cashier --> UC3
cashier --> UC4
cashier --> UC5
cashier --> UC6
cashier --> UC7 : <<SoD Ã¡p dá»¥ng>>
cashier --> UC8
cashier --> UC9
cashier --> UC10
cashier --> UC11
cashier --> UC12
cashier --> UC13
cashier --> UC14

' Manager - Read only reports
manager --> UC14 : <<chá»‰ Ä‘á»c>>
manager --> UC15 : <<chá»‰ Ä‘á»c>>
manager --> UC16 : <<chá»‰ Ä‘á»c>>

' Relationships
UC1 ..> patient : <<cho bá»‡nh nhÃ¢n>>
UC10 ..> patient : <<claim cho>>

note right of UC7
  **SoD Rule:**
  NgÆ°á»i táº¡o Invoice
  khÃ´ng thá»ƒ tá»± approve
end note

note right of cashier
  **Deny Rules:**
  âŒ KhÃ´ng truy cáº­p Clinical Data
  âŒ KhÃ´ng xem MedicalRecord
  âŒ KhÃ´ng xem Prescription
end note

note bottom of manager
  **ABAC:**
  Manager chá»‰ xem
  bÃ¡o cÃ¡o cÃ¹ng chi nhÃ¡nh
  vÃ  cÃ¹ng phÃ²ng ban
end note

@enduml

@startuml usecase-hr-domain
!theme cerulean
title Use Case: HR Domain (NhÃ¢n sá»± & Quáº£n lÃ½)

left to right direction
skinparam actorStyle awesome

actor "NhÃ¢n sá»±\n(HR)" as hr #LightCoral
actor "Quáº£n lÃ½" as manager #Lavender
actor "NhÃ¢n viÃªn" as staff #WhiteSmoke

rectangle "HR Domain" {
    package "Quáº£n lÃ½ NhÃ¢n viÃªn" {
        usecase "Táº¡o há»“ sÆ¡ nhÃ¢n viÃªn" as UC1
        usecase "Xem há»“ sÆ¡ nhÃ¢n viÃªn" as UC2
        usecase "Cáº­p nháº­t há»“ sÆ¡" as UC3
        usecase "TÃ¬m kiáº¿m nhÃ¢n viÃªn" as UC4
        usecase "Quáº£n lÃ½ tráº¡ng thÃ¡i" as UC5
    }
    
    package "Lá»‹ch lÃ m viá»‡c" {
        usecase "Táº¡o lá»‹ch lÃ m viá»‡c" as UC6
        usecase "Xem lá»‹ch lÃ m viá»‡c" as UC7
        usecase "Cáº­p nháº­t ca lÃ m" as UC8
        usecase "PhÃ¢n cÃ´ng ca trá»±c" as UC9
    }
    
    package "ÄÃ o táº¡o & Chá»©ng chá»‰" {
        usecase "Táº¡o há»“ sÆ¡ Ä‘Ã o táº¡o" as UC10
        usecase "Xem lá»‹ch sá»­ Ä‘Ã o táº¡o" as UC11
        usecase "Cáº­p nháº­t chá»©ng chá»‰" as UC12
        usecase "Theo dÃµi háº¿t háº¡n" as UC13
    }
    
    package "BÃ¡o cÃ¡o Váº­n hÃ nh" {
        usecase "Xem bÃ¡o cÃ¡o nhÃ¢n sá»±" as UC14
        usecase "Xem thá»‘ng kÃª cháº¥m cÃ´ng" as UC15
        usecase "Xem hiá»‡u suáº¥t Ä‘Ã o táº¡o" as UC16
    }
}

' HR - Full CRUD
hr --> UC1
hr --> UC2
hr --> UC3
hr --> UC4
hr --> UC5
hr --> UC6
hr --> UC7
hr --> UC8
hr --> UC9
hr --> UC10
hr --> UC11
hr --> UC12
hr --> UC13
hr --> UC14
hr --> UC15
hr --> UC16

' Manager - Limited read
manager --> UC2 : <<chá»‰ Ä‘á»c, cÃ¹ng khoa>>
manager --> UC7 : <<chá»‰ Ä‘á»c, cÃ¹ng khoa>>
manager --> UC14 : <<chá»‰ Ä‘á»c>>

' Relationships
UC1 ..> staff : <<táº¡o cho>>
UC6 ..> staff : <<lÃªn lá»‹ch cho>>
UC10 ..> staff : <<ghi nháº­n>>

note right of hr
  **Deny Rules:**
  âŒ KhÃ´ng truy cáº­p Patient Data
  âŒ KhÃ´ng truy cáº­p Finance Data
  âŒ KhÃ´ng xem MedicalRecord
  âŒ KhÃ´ng xem BillingRecord
end note

note bottom of manager
  **ABAC Constraints:**
  - Chá»‰ nhÃ¢n viÃªn cÃ¹ng chi nhÃ¡nh
  - Chá»‰ nhÃ¢n viÃªn cÃ¹ng phÃ²ng ban
end note

@enduml

@startuml usecase-system-domain
!theme cerulean
title Use Case: System Domain (IT Admin & Security Admin)

left to right direction
skinparam actorStyle awesome

actor "IT Admin" as itadmin #LightGray
actor "Security Admin" as secadmin #Tomato

rectangle "System Domain" {
    package "Cáº¥u hÃ¬nh Há»‡ thá»‘ng" {
        usecase "Xem cáº¥u hÃ¬nh" as UC1
        usecase "Cáº­p nháº­t cáº¥u hÃ¬nh" as UC2
        usecase "Quáº£n lÃ½ tham sá»‘ báº£o máº­t" as UC3
        usecase "Cáº¥u hÃ¬nh tÃ­ch há»£p" as UC4
    }
    
    package "ChÃ­nh sÃ¡ch Truy cáº­p" {
        usecase "Xem Access Policy" as UC5
        usecase "Táº¡o Policy má»›i" as UC6
        usecase "Cáº­p nháº­t Policy" as UC7
        usecase "Báº­t/Táº¯t Policy" as UC8
    }
    
    package "Audit & GiÃ¡m sÃ¡t" {
        usecase "Xem Audit Logs" as UC9
        usecase "TÃ¬m kiáº¿m logs" as UC10
        usecase "Thá»‘ng kÃª audit" as UC11
        usecase "Export audit logs" as UC12
    }
    
    package "Quáº£n lÃ½ Sá»± cá»‘" {
        usecase "BÃ¡o cÃ¡o sá»± cá»‘" as UC13
        usecase "Xem danh sÃ¡ch sá»± cá»‘" as UC14
        usecase "Cáº­p nháº­t sá»± cá»‘" as UC15
        usecase "PhÃ¢n cÃ´ng xá»­ lÃ½" as UC16
        usecase "ÄÃ³ng sá»± cá»‘" as UC17
        usecase "Thá»‘ng kÃª sá»± cá»‘" as UC18
    }
}

' IT Admin
itadmin --> UC1
itadmin --> UC2
itadmin --> UC3
itadmin --> UC4
itadmin --> UC5 : <<chá»‰ Ä‘á»c>>
itadmin --> UC9
itadmin --> UC10
itadmin --> UC11

' Security Admin
secadmin --> UC1 : <<chá»‰ Ä‘á»c>>
secadmin --> UC5
secadmin --> UC6
secadmin --> UC7
secadmin --> UC8
secadmin --> UC9
secadmin --> UC10
secadmin --> UC11
secadmin --> UC12
secadmin --> UC13
secadmin --> UC14
secadmin --> UC15
secadmin --> UC16
secadmin --> UC17
secadmin --> UC18

note right of itadmin
  **Deny Rules:**
  âŒ KhÃ´ng truy cáº­p Patient Data
  âŒ KhÃ´ng xem PatientProfile
  âŒ KhÃ´ng xem MedicalRecord
  âŒ KhÃ´ng quáº£n lÃ½ Incident
end note

note right of secadmin
  **Permissions:**
  âœ… Full Incident Management
  âœ… Access Policy CRUD
  âœ… Audit Log access
  âœ… SystemConfig (read only)
end note

@enduml

@startuml usecase-authentication
!theme cerulean
title Use Case: Authentication & Authorization

left to right direction
skinparam actorStyle awesome

actor "NgÆ°á»i dÃ¹ng" as user
actor "Há»‡ thá»‘ng" as system

rectangle "Authentication & Authorization" {
    package "XÃ¡c thá»±c (Authentication)" {
        usecase "ÄÄƒng nháº­p" as UC1
        usecase "ÄÄƒng xuáº¥t" as UC2
        usecase "Xem thÃ´ng tin cÃ¡ nhÃ¢n" as UC3
        usecase "Refresh Token" as UC4
    }
    
    package "PhÃ¢n quyá»n (Authorization)" {
        usecase "Kiá»ƒm tra quyá»n" as UC5
        usecase "Kiá»ƒm tra nhanh permission" as UC6
        usecase "Kiá»ƒm tra batch permissions" as UC7
    }
    
    package "Audit" {
        usecase "Ghi log truy cáº­p" as UC8
        usecase "ÄÃ¡nh giÃ¡ rá»§i ro" as UC9
        usecase "ThÃªm obligations" as UC10
    }
}

user --> UC1
user --> UC2
user --> UC3
user --> UC4
user --> UC5
user --> UC6
user --> UC7

UC5 ..> UC8 : <<include>>
UC5 ..> UC9 : <<include>>
UC5 ..> UC10 : <<include>>

system --> UC8
system --> UC9
system --> UC10

note right of UC5
  **Authorization Flow:**
  1. RBAC Check
  2. Deny Rules Check
  3. ABAC Check
  4. Risk Scoring
  5. Add Obligations
  6. Audit Logging
end note

note bottom of UC9
  **Risk Factors:**
  - Off-hours: +2
  - Export action: +3
  - High sensitivity: +2
  - High-risk resource: +3
end note

@enduml

@startuml usecase-abac-scenarios
!theme cerulean
title Use Case: ABAC Scenarios & Constraints

left to right direction
skinparam actorStyle awesome

actor "BÃ¡c sÄ© CN_HN" as doc_hn #LightBlue
actor "BÃ¡c sÄ© CN_HCM" as doc_hcm #LightBlue
actor "Y tÃ¡ Khoa Ná»™i" as nurse_noi #LightGreen
actor "Y tÃ¡ Khoa Ngoáº¡i" as nurse_ngoai #LightGreen

rectangle "ABAC Scenarios" {
    package "Branch Constraint" {
        usecase "Xem BN chi nhÃ¡nh HN" as UC1
        usecase "Xem BN chi nhÃ¡nh HCM" as UC2
    }
    
    package "Department Constraint" {
        usecase "Xem BN Khoa Ná»™i" as UC3
        usecase "Xem BN Khoa Ngoáº¡i" as UC4
    }
    
    package "Patient Assignment" {
        usecase "Xem BN Ä‘Æ°á»£c assign" as UC5
        usecase "Xem BN khÃ´ng Ä‘Æ°á»£c assign" as UC6
    }
    
    package "Separation of Duties" {
        usecase "Táº¡o Prescription" as UC7
        usecase "Approve Prescription" as UC8
    }
}

' Branch scenarios
doc_hn --> UC1 : âœ… Allowed
doc_hn --> UC2 : âŒ BRANCH_MISMATCH
doc_hcm --> UC1 : âŒ BRANCH_MISMATCH
doc_hcm --> UC2 : âœ… Allowed

' Department scenarios
nurse_noi --> UC3 : âœ… Allowed
nurse_noi --> UC4 : âŒ Denied
nurse_ngoai --> UC3 : âŒ Denied
nurse_ngoai --> UC4 : âœ… Allowed

' Patient assignment scenarios
doc_hn --> UC5 : âœ… Allowed
doc_hn --> UC6 : âŒ Not Assigned

' SoD scenarios
doc_hn --> UC7 : âœ… Create
doc_hn --> UC8 : âŒ SOD (own prescription)
doc_hcm --> UC8 : âœ… Approve (other's prescription)

note bottom of UC1
  **Branch Check:**
  user.branch == resource.branch
end note

note bottom of UC3
  **Department Check:**
  user.department == resource.department
  (Required for Nurse role)
end note

note right of UC6
  **Patient Assignment:**
  patientId âˆˆ user.assignedPatients
end note

note right of UC8
  **SoD Rule:**
  resource.createdBy != user.userId
end note

@enduml

@startuml er-diagram
!theme cerulean
title Entity Relationship Diagram

entity "users" as users {
    *id : BIGSERIAL <<PK>>
    --
    *user_id : VARCHAR(50) <<UK>>
    *username : VARCHAR(100) <<UK>>
    *password : VARCHAR(255)
    *role_id : BIGINT <<FK>>
    department : VARCHAR(100)
    branch : VARCHAR(50)
    position : VARCHAR(100)
    has_license : BOOLEAN
    seniority : VARCHAR(20)
    employment_type : VARCHAR(20)
    enabled : BOOLEAN
    account_non_expired : BOOLEAN
    account_non_locked : BOOLEAN
    credentials_non_expired : BOOLEAN
    created_at : TIMESTAMP
    updated_at : TIMESTAMP
}

entity "roles" as roles {
    *id : BIGSERIAL <<PK>>
    --
    *name : VARCHAR(50) <<UK>>
    description : VARCHAR(255)
}

entity "permissions" as permissions {
    *id : BIGSERIAL <<PK>>
    --
    *resource_type : VARCHAR(100)
    *action : VARCHAR(50)
    scope : VARCHAR(50)
    description : VARCHAR(255)
    *permission_key : VARCHAR(255) <<UK>>
}

entity "role_permissions" as role_perm {
    *role_id : BIGINT <<FK>>
    *permission_id : BIGINT <<FK>>
}

entity "user_permissions" as user_perm {
    *user_id : BIGINT <<FK>>
    *permission_id : BIGINT <<FK>>
}

entity "user_assigned_patients" as user_patients {
    *user_id : BIGINT <<FK>>
    *patient_id : VARCHAR(50)
}

entity "audit_logs" as audit {
    *id : BIGSERIAL <<PK>>
    --
    *user_id : VARCHAR(50)
    *resource_type : VARCHAR(100)
    *resource_id : VARCHAR(100)
    *action : VARCHAR(50)
    *allowed : BOOLEAN
    policy_id : VARCHAR(255)
    deny_reasons : VARCHAR(1000)
    risk_score : INTEGER
    *timestamp : TIMESTAMP
    ip_address : VARCHAR(50)
    user_agent : VARCHAR(500)
}

users ||--o{ role_perm : "role_id"
users ||--o{ user_perm : "user_id"
users ||--o{ user_patients : "user_id"
roles ||--o{ role_perm : "role_id"
permissions ||--o{ role_perm : "permission_id"
permissions ||--o{ user_perm : "permission_id"

@enduml

